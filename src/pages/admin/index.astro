---
import { db, Group, Media, eq } from "astro:db";
const groups = await db.select().from(Group).orderBy(Group.date);

async function fetchMedia(groupId: number) {
  return await db.select().from(Media).where(eq(Media.groupId, groupId));
}

export const prerender = false;
---
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/src/styles/admin.css" />
    <title>–ê–¥–º–∏–Ω–∫–∞</title>
  </head>
  <body>
    <div class="container">
      <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
      <a href="/admin/new">‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</a>

      <ul class="group-list">
        {groups.map(async (g) => (
          <li>
            <b>{g.title}</b> ‚Äî {g.link} 
            <a href={`/admin/edit/${g.id}`}>‚úèÔ∏è</a>
            <form method="post" action={`/admin/delete/${g.id}`} style="display:inline" class="delete" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')">
                <button type="submit">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </form>

            <!-- –ú–µ–¥–∏–∞ -->
            <ul class="media-list">
              {await fetchMedia(g.id).then((media) =>
                media.map((m) => (
                  <li>
                    {m.type === 'image' ? (
                      <img src={m.url} alt={m.alt ?? ''} />
                    ) : (
                      <video src={m.url} poster={m.poster ?? ''} controls />
                    )}
                  </li>
                ))
              )}
            </ul>

            <form method="post" action="/api/upload" enctype="multipart/form-data">
              <input type="hidden" name="groupId" value={g.id} />
              <input type="file" name="file" multiple />
              <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞</button>
            </form>
          </li>
        ))}
      </ul>
    </div>
  </body>
</html>
