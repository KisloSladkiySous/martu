---
import { db, Group, Reviews, Media, eq } from "astro:db";

const groups = await db.select().from(Group);
const reviews = await db.select().from(Reviews);
// console.log(groups);

async function fetchMedia(groupId: number) {
  return await db.select().from(Media).where(eq(Media.groupId, groupId));
}

async function fetchMediaById(mediaId: number | null) {
  if (!mediaId) return null;
  const [media] = await db.select().from(Media).where(eq(Media.id, mediaId));
  return media;
}

export const prerender = false;
---

<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–ê–¥–º–∏–Ω–∫–∞</title>
    <link rel="stylesheet" href="/src/styles/admin.css" />
    <style>
      .tabs {
        display: flex;
        margin-bottom: 1rem;
        cursor: pointer;
      }
      .tab {
        padding: 0.5rem 1rem;
        border: 1px solid #ccc;
        border-bottom: none;
      }
      .tab.active {
        background: #3498db;
        color: #fff;
      }
      .tab-content {
        border: 1px solid #ccc;
        padding: 1rem;
      }
      .group-list,
      .review-list {
        list-style: none;
        padding: 0;
      }
      .media-list img,
      .media-list video {
        max-width: 100px;
        margin-right: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>–ê–¥–º–∏–Ω–∫–∞</h1>

      <div class="tabs">
        <div class="tab active">–ì—Ä—É–ø–ø—ã</div>
        <div class="tab">–û—Ç–∑—ã–≤—ã</div>
      </div>

      <div id="groups" class="tab-content">
        <a href="/admin/portfolio/new">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</a>
        <ul class="group-list">
          {
            groups.map(async (g) => (
              <li>
                <b>{g.title}</b> ‚Äî {g.link}
                <a href={`/admin/portfolio/edit/${g.id}`}>‚úèÔ∏è</a>
                <form
                  method="post"
                  action={`/admin/portfolio/delete/${g.id}`}
                  style="display:inline"
                  class="delete"
                  onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')"
                >
                  <button type="submit">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </form>
                <ul class="media-list">
                  {await fetchMedia(g.id).then((media) =>
                    media.map((m) => (
                      <li>
                        {m.type === "image" ? (
                          <img src={m.url} alt={m.alt ?? ""} />
                        ) : (
                          <video src={m.url} poster={m.poster ?? ""} controls />
                        )}
                      </li>
                    ))
                  )}
                </ul>
                <form
                  method="post"
                  action="/api/upload"
                  enctype="multipart/form-data"
                >
                  <input type="hidden" name="groupId" value={g.id} />
                  <input type="file" name="file" multiple />
                  <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞</button>
                </form>
              </li>
            ))
          }
        </ul>
      </div>

      <div id="reviews" class="tab-content" style="display:none;">
        <a href="/admin/reviews/new">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</a>
        <ul class="review-list">
          {
            await Promise.all(
              reviews.map(async (r) => {
                const media = await fetchMediaById(r.mediaId);
                const authorImage = await fetchMediaById(r.authorImageId);
                return (
                  <li>
                    <b>{r.author}</b>: {r.text}
                    <a href={`/admin/reviews/edit/${r.id}`}>‚úèÔ∏è</a>
                    <form
                      method="post"
                      action={`/admin/reviews/delete/${r.id}`}
                      style="display:inline"
                      onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?')"
                    >
                      <button type="submit" class="delete">
                        üóëÔ∏è
                      </button>
                    </form>
                    <div class="media-list">
                      {authorImage && (
                        <img src={authorImage.url} alt="–§–æ—Ç–æ –∞–≤—Ç–æ—Ä–∞" />
                      )}
                      {media && media.type === "image" && (
                        <img src={media.url} alt="–ú–µ–¥–∏–∞" />
                      )}
                      {media && media.type === "video" && (
                        <video src={media.url} controls />
                      )}
                    </div>
                  </li>
                );
              })
            )
          }
        </ul>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const tabs = document.querySelectorAll(".tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const target = tab.textContent.toLowerCase();
            document.getElementById("groups")!.style.display =
              target === "–≥—Ä—É–ø–ø—ã" ? "block" : "none";
            document.getElementById("reviews")!.style.display =
              target === "–æ—Ç–∑—ã–≤—ã" ? "block" : "none";

            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
          });
        });
      });
    </script>
  </body>
</html>
